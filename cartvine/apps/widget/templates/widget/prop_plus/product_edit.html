{% extends 'widget/widget_edit.html' %}
{% load i18n templatetag_handlebars product_tags %}
{% load url from future %}

{% block title %}{% trans 'Product Detail' %} - {{ object.name }}{% endblock %}

{% block pre-body %}
    <span class="pull-right"><a href="{{ object.shop.url }}{{ object.shopify_url }}" class="btn">{% trans 'View in Shopify' %}</a></span>
    <h2>{{ object.name }}</h2>
{% endblock %}

{% block body %}
<div class="main">
    <div class="row">
        <div class="span9">
            <div class="widget widget-table">
                <div class="widget-header">
                    <span class="icon-list-alt"></span>
                    <h3>{% trans 'Product Properties' %}</h3>
                    <button type="edit" class="btn btn-warning pull-right" data-toggle="modal" href="#editPropertiesModal" >{% trans 'Edit Properties' %}</button>
                </div>                  
                <div class="widget-content">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>                                
                                <th class="span3">{% trans 'Property name' %}</th>
                                <th>{% trans 'Value' %}</th>                                
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="name">{% trans 'Product' %}</td>
                                <td class="value"><span>{{ object.name }}</span></td>
                            </tr>
                            <tr>
                                <td class="name">{% trans 'Product type' %}</td>
                                <td class="value"><span>{{ object.product_type }}</span></td>
                            </tr>
                            <tr>
                                <td class="name">{% trans 'Product vendor' %}</td>
                                <td class="value"><span>{{ object.data.vendor }}</span></td>
                            </tr>
                            {% for property in object.basic_props %}
                            <tr>
                                <td class="name">{{ property.name }}</td>
                                <td class="value">{% for p in property.value %}<span class="label label-info">{{ p }}</span>&nbsp;{% endfor %}</td>
                            </tr>
                            {% endfor %}
                            {% for property in object.properties_plus %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="span3">
            <!-- Product image, taken out for the moment, not critical. 
            <div class="widget">
                                {% if object.featured_image_src %}
                                    <img id="feature-image" src="{{ object.featured_image_src|image_resize:"medium" }}" border="0"/>
                                {% else %}
                                    <img src="http://placehold.it/300x150&text=No Product Thumb">
                                {% endif %}
                                {% for i in object.get_images_src %}
                                    <img class="product image" src="{{ i|image_resize:"medium" }}" border="0"/>
                                {% endfor %}
                                
            </div> -->
            <!--Product description block-->
            <div class="widget">
                <div class="widget-header">
                    <i class="icon-pushpin"></i>
                    <h3>{% trans 'Product Description' %}</h3>
                </div> <!-- /widget-header -->
                <div class="widget-content">
                    {{ object.summary|safe|truncatewords:30 }}
                </div>
            </div>
            <!--Product tags block-->
            <div class="widget">
                <div class="widget-header">
                    <i class="icon-pushpin"></i>
                    <h3>{% trans 'Product Tags' %} </h3>
                </div> <!-- /widget-header -->
                <div class="widget-content">
                    {{ object.data.tags }}
                </div>
            </div>
        </div>
        <div class="span12">
            <div class="widget widget-table" data-bind="with: VariantView">
                <div class="widget-header">
                    <span class="icon-barcode"></span>
                    <h3>{% trans 'Product Inventory' %} (<span data-bind="text: variantsList().length"></span>)</h3>
                </div>
                <div class="widget-content">
					<table class="table table-bordered table-striped table-condensed">
						<thead>
							<tr>
								<th class="cen span1"><input type="checkbox" id="toggle-all-variants"></th>
								<th>SKU</th>
								<th>Price</th>
								<th>In Stock</th>
								{% for option in object.basic_props %}
								<th>{{ option.name }}</th>
								{% endfor %}
								<th></th>
							</tr>
						</thead>
						<tbody>
						    {% for variant in variants %}
						    <tr>
                                <td class="cen"><input type="checkbox" class="option-variant" value=""/></td>
                                <td class="value">{{variant.sku}}</td>
                                <td class="value">{{variant.cost}}</td>
                                <td class="value">{{variant.inventory_quantity}}</td>
                                {% for option_id,option in variant.basic_options.iteritems %}
                                <td class="value">{{ option.value }}</td>
                                {% endfor %}
                                <td class="value cen">
                                <a data-toggle="modal" data-variant_pk="{{ variant.pk }}" href="#editVariationModal" class="btn-modal-form btn btn-mini btn-warning">{% trans 'Edit' %}</a>
                                <a href="#" class="btn btn-mini disabled pull-right"><i class="icon-resize-vertical"></i></a>
                                </td>
						    </tr>
						    {% endfor %}
						</tbody>
					</table>
                    <table class="table table-condensed">
                    <tr>
                        <td class="span10">
                            <select name="variant-select-options" id="variant-select-options">
                                <option value="null"></option>
                                <optgroup label="Shopify Functions">
                                    <option value="sync-variants">{% trans 'Sync Selected with Shopify' %}</option>
                                </optgroup>
                                <optgroup label="Danger Zone">
                                    <option value="delete-variants">{% trans 'Delete Selected' %}</option>
                                </optgroup>
                            </select>
                        </td>
                        <td class="span2"><a data-toggle="modal" data-variant_pk="add" href="#editVariationModal" class="btn-modal-form btn btn-small btn-success pull-right">{% trans 'Add Variation' %}</a></td>
                    </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="{{ STATIC_URL }}knockoutjs/js/knockout-2.1.0.js"></script>
<div data-bind="with: ProductView">
{% include 'product/forms/product_props.html' %}
</div>
<div data-bind="with: VariantView">
{% include 'product/forms/variant_props.html' %}
</div>
<script type="text/javascript">
$(document).ready(function(){

    function ProductViewModel() {
        var self = this;
    }

    function VariantViewModel() {
        var self = this;

        self.blankVariant = new Variant(null,null,0,null,0,0,false,false,false,0,[]);
        self.currency = '{{ object.shop.currency_symbol|safe }}';
        self.selectedVariant = ko.observable(self.blankVariant);
        self.basicProductOptions = ko.observableArray([{% for o,v in object.get_data_options.iteritems %}new ProductOption('{{ o }}','{{ v.name }}','{{ v.value }}'),{% endfor %}]);
        self.extraProductOptions = ko.observableArray([]);
        self.currencySymbol = '{{ object.shop.currency_symbol|safe }}';

        self.formTitle = ko.observable('');
        self.formSubmitMessage = ko.observable('');
        self.formPostUrl = ko.observable('');

        self.variantsList = ko.observableArray([]);
        var variant_list = eval($('script#data-variant_list').html());
        for (var i = 0; i < variant_list.length; i++) {
            v = variant_list[i];
            variant = new Variant(v.pk,v.provider_id,v.cost,v.sku,v.compare_at_price,v.weight,v.taxable,v.requires_shipping,v.inventory_management,v.inventory_quantity,v.basic_options);
            self.variantsList.push(variant);
        }

        self.appendToVariantList = function(variant) {
            var is_present = false;
            if (variant.pk != undefined) {
                for (var i=0; i < self.variantsList().length; i++) {
                    if (self.variantsList()[i].pk == variant.pk) {
                        is_present = true;
                        break;
                    }
                }
                if (is_present == false) {
                    self.variantsList.push(variant);
                    console.log('appendToVariantList: ' + variant)
                    self.setSelectedVariant(variant.pk);
                }
            }
        }

        self.setSelectedVariant = function(variant_pk) {
            for (var i=0; i < self.variantsList().length; i++) {
                if (self.variantsList()[i].pk == variant_pk) {
                    return self.updateSelectedVariant(self.variantsList()[i])
                    break;
                }
            }
            return self.updateSelectedVariant(self.blankVariant)
        }

        self.updateSelectedVariant = function(variant) {
            self.formSubmitMessage('');
            self.selectedVariant(variant);
            self.selectedVariant().setVariantBasicProperties();
            self.updateVariantPropsPostUrl();

            return self.selectedVariant
        }

        self.updateVariantPropsPostUrl = function() {
            var url = "{% url 'product:variant' slug=object.slug variant_pk=999 %}";

            if (self.selectedVariant().pk !== null) {
                self.formTitle('{% trans "Edit a Variant" %}');
                url = url.replace('999', self.selectedVariant().pk) + '?provider_id=' + self.selectedVariant().provider_id;
            }else{
                self.formTitle('{% trans "Add a Variant" %}');
                url = "{% url 'product:add_variant' slug=object.slug %}";
            }
            self.formPostUrl(url);
            return self.formPostUrl;
        }
    };

    function Variant(pk,provider_id,cost,sku,compare_at_price,weight,taxable,requires_shipping,inventory_management,inventory_quantity,basic_product_options) {
        var self = this;
        self.pk = pk;
        self.provider_id = provider_id;
        self.cost = cost;
        self.sku = sku;
        self.compare_at_price = compare_at_price;
        self.weight = weight;
        self.taxable = taxable;
        self.requires_shipping = requires_shipping;
        self.inventory_management = inventory_management;
        self.inventory_quantity = inventory_quantity;
        self.basic_product_options = basic_product_options;
        self.basic_props = ko.observableArray([]);

        self.setVariantBasicProperties = function() {
            // reset
            self.basic_props([]);

            for (var i = 0; i < App.VariantView.basicProductOptions().length; i++) {
                prop_type = App.VariantView.basicProductOptions()[i].prop_type;

                field_name = App.VariantView.basicProductOptions()[i].prop_type
                name = App.VariantView.basicProductOptions()[i].internal_name;

                if (self.basic_product_options.length == 0) {
                    value = ' ';
                }else{
                    if (self.basic_product_options[prop_type].value != '') {
                        value = self.basic_product_options[prop_type].value;
                    }else{
                        value = ' ';
                    }
                }

                if (name != '' && name != 'None' && value != '' && value != 'None') {
                    self.basic_props.push({'field_name': field_name, 'name': name, 'value':  value})
                }
            }
        }
    }
    function ProductOption(prop_type,internal_name,name,value) {
        var self = this;
        self.prop_type = prop_type;
        self.internal_name = internal_name;
        self.name = name;
        self.value = value;
    }

    $('#editVariationModal a.submit-btn:last').live('click', function(event) {
        event.preventDefault();
        App.submitModalWindow(App.VariantView, $('div#editVariationModal'));
    });
    
    $('a.btn-modal-form').live('click', function(event) {
        event.preventDefault();
        var variant_pk = $(this).attr('data-variant_pk');
        if (variant_pk != undefined && variant_pk != 'add') {
            App.VariantView.setSelectedVariant(variant_pk);
        }else{
            App.VariantView.updateSelectedVariant(App.VariantView.blankVariant);
        }
    });

    $('#toggle-all-variants').live('click', function(event) {
        if ($(this).attr('checked') == 'checked') {
            $('input[type="checkbox"].option-variant').attr('checked', 'checked')
        }else{
            $('input[type="checkbox"].option-variant').attr('checked', false)
        }
    });
    $('select#variant-select-options').live('change', function(event) {
        event.preventDefault();
        num_items_selected = $('input[type="checkbox"].option-variant:checked').length;
        if (num_items_selected > 0) {
            items_selected = $('input[type="checkbox"].option-variant:checked');
            console.log('Send '+ $(this).val() +' event to backend for ids: ' + items_selected);
        }
        $(this).prop('selectedIndex', 0);
    });
    /**
    * Primary view acts as a holder for the other views
    */
    function PageMasterViewModel() {
        var self = this;
        self.VariantView = new VariantViewModel();
        self.ProductView = new ProductViewModel();

        self.submitModalWindow = function(KOView, baseElement) {
            // hide sumit button so suer cant double click
            footer = baseElement.find('div.modal-footer:last');
            submit_button = baseElement.find('.submit-btn');
            form_message = $('div.form-message:first');
            submit_button.css('visibility','hidden');
            submit_button.attr('disabled',true);

            $.ajax({
              type: 'POST',
              url: KOView.formPostUrl(),
              data: $('#form-variant-props').serialize(),
              dataType: 'json'
            })
            .success(function(data, textStatus, jqXHR) { 
                // make the JSON response usable
                response = eval(data);

                form_message.hide().removeClass('btn-success,btn-warning');

                console.log(response.status)
                if (response.status == 'success') {
                    status_class = 'btn-success';
                    // successful post now update the variants list
                    if (response.object != null) {
                        v = response.object;
                        variant = new Variant(v.pk,v.provider_id,v.price,v.sku,v.compare_at_price,v.grams,v.taxable,v.requires_shipping,v.inventory_policy,v.inventory_quantity,v.basic_options);
                        KOView.appendToVariantList(variant);
                    }
                }else{
                    status_class = 'btn-warning';
                }

                // Set the form Message
                KOView.formSubmitMessage(response.message);
                form_message.fadeIn('fast').addClass(status_class).addClass('messages')

                if (response.status == 'success') {
                    setTimeout(function () {
                        $('#editVariationModal').modal('hide');
                    }, 1500);
                }
                submit_button.css('visibility','visible');
                submit_button.attr('disabled',false);
            })
            .error(function() { 
                KOView.formSubmitMessage('Sorry, something bad happened!');
                form_message.hide().fadeIn('slow').removeClass().addClass('btn-danger').addClass('messages')
                submit_button.css('visibility','visible');
                submit_button.attr('disabled',false);
            })
            .complete(function() {});
        }
    }
    // ----- KO Instance -----
    App = new PageMasterViewModel()
    // ----- KO Bindings -----
    ko.applyBindings(App);
});
</script>
{% endblock %}

