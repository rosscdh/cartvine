// ==========================================================================
// Project:  Ember Data
// Copyright: ©2012 Gordon L. Hempton (http://codebrief.com) and Contributors
//            Portions ©2006-2011 Strobe Inc.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================


(function(a){var b=Ember.get,c=Ember.set,d=!!window.history&&!!window.history.pushState,e="onhashchange"in window&&(document.documentMode===undefined||document.documentMode>7);Ember.RouteManager=Ember.StateManager.extend({wantsHistory:!1,usesHistory:null,baseURI:document.baseURI,_didSetup:!1,_location:null,_extractParametersAndRoute:function(a){var b={},c=a.route||"",d,e,f,g,h,i;d=c.indexOf("?")<0&&c.indexOf("&")>=0?"&":"?",e=c.split(d),c=e[0],e.length===1?e=[]:e.length===2?e=e[1].split("&"):e.length>2&&e.shift(),g=e.length;for(f=0;f<g;++f)h=e[f].split("="),b[h[0]]=h[1];for(i in a)a.hasOwnProperty(i)&&i!=="route"&&(b[i]=""+a[i]);e=[];for(i in b)e.push([i,b[i]].join("="));return b.params=d+e.join("&"),b.route=c,b},location:Ember.computed(function(a,b){return this._skipRoute=!1,this._extractLocation(a,b)}).property(),_extractLocation:function(a,c){var d,e;if(c!==undefined){c===null&&(c=""),typeof c=="object"&&(d=this._extractParametersAndRoute(c),c=d.route+d.params);if(!this._skipPush&&(!Ember.empty(c)||this._location&&this._location!==c)){e=encodeURI(c);if(this.usesHistory)e="/"+e,window.history.pushState(null,null,b(this,"baseURI")+e);else if(e.length>0||window.location.hash.length>0)window.location.hash="!"+e}this._location=c}return this._location},updateLocation:function(a){return this._skipRoute=!0,this._extractLocation("location",a)},start:function(){if(!this._didSetup){this._didSetup=!0;var a="";if(b(this,"wantsHistory")&&d)this.usesHistory=!0,Ember.empty(window.location.hash)||(a=window.location.hash.slice(1),a.length>0&&(a="/"+a,window.history.replaceState(null,null,b(this,"baseURI")+a))),this.popState(),this.popState=jQuery.proxy(this.popState,this),jQuery(window).bind("popstate",this.popState);else{this.usesHistory=!1;if(b(this,"wantsHistory")){var c=b(this,"baseURI"),f=c.charAt(0)==="/"?document.location.pathname:document.location.href.replace(document.location.hash,"");a=f.slice(c.length+1),a.length>0&&(window.location.href=c+"#!"+a)}if(e)this.hashChange(),this.hashChange=jQuery.proxy(this.hashChange,this),jQuery(window).bind("hashchange",this.hashChange);else{var g=this,h=function(){g.hashChange(),g._timerId=setTimeout(h,100)};h()}}}},stop:function(){this._didSetup&&(b(this,"wantsHistory")&&d?jQuery(window).unbind("popstate",this.popState):e?jQuery(window).unbind("hashchange",this.hashChange):clearTimeout(this._timerId),this._didSetup=!1)},destroy:function(){this.stop(),this._super()},locationDidChange:Ember.observer(function(){this.trigger()},"location"),trigger:function(){var a=b(this,"location"),d,e;d=this._extractParametersAndRoute({route:a}),a=d.route,delete d.route,delete d.params;var f=this.getState(a,d);if(f){c(this,"params",f.params);if(f.cleanStates.length>0){var g=f.cleanStates.join(".");this.goToState(g)}if(f.dirtyStates.length>0){var h=f.cleanStates.concat(f.dirtyStates).join(".");this.currentState&&h===this.currentState.get("path")&&this.goToState("__nullState"),this.goToState(h)}}else{var i=b(this,"states");i&&b(i,"404")&&this.goToState("404")}},getState:function(a,b){var c=a.split("/");return c=c.filter(function(a){return a!==""}),this._findState(c,this,[],[],b,!1)},_findState:function(a,b,c,d,e){a=Ember.copy(a);var f=!1,g,h,i;h=[];for(g in b.states){i=b.states[g];if(g=="404"||!Ember.State.detect(i)&&!(i instanceof Ember.State))continue;h.push({name:g,state:i})}h=h.sort(function(a,b){return(b.state.get("priority")||0)-(a.state.get("priority")||0)});for(var j=0;j<h.length;j++){g=h[j].name,i=h[j].state;if(!(i instanceof Ember.State))continue;f=!0;var k=this._matchState(a,i,e);if(!k)continue;var l=Ember.copy(e);jQuery.extend(l,k.params);var m=d.length>0||k.dirty,n=c,o=d;m?(o=Ember.copy(o),o.push(g)):(n=Ember.copy(n),n.push(g)),k=this._findState(k.parts,i,n,o,l);if(k)return k}return!f&&a.length===0?{state:b,params:e,cleanStates:c,dirtyStates:d}:null},_matchState:function(a,c,d){a=Ember.copy(a),d=Ember.copy(d);var e=!1,f=b(c,"route");if(f){var g;typeof f=="string"?g=f.split("/"):f instanceof RegExp?g=[f]:Ember.assert("route must be either a string or regexp",!1);for(var h=0;h<g.length;h++){if(a.length===0)return!1;var i=a.shift(),j=g[h],k=this._matchPart(j,i,c);if(!k)return!1;var l=this.get("params")||{};for(var m in k)e=e||l[m]!=k[m];jQuery.extend(d,k)}}var n=b(c,"enabled");return n!==undefined&&!n?!1:{parts:a,params:d,dirty:e}},_matchPart:function(a,c,d){var e={};if(typeof a=="string"){switch(a.slice(0,1)){case":":var f=a.slice(1,a.length);return e[f]=c,e;case"*":return{};default:if(a==c)return{}}return!1}if(a instanceof RegExp){var g=b(d,"captures"),h=a.exec(c);if(h){if(g){var i=g.length,j;for(j=0;j<i;++j)e[g[j]]=h[j+1]}return e}return!1}return!1},hashChange:function(a){var d=window.location.hash,e=this;d=d&&d.length>1?d.slice(2,d.length):"",jQuery.browser.mozilla||(d=decodeURI(d)),b(e,"location")!==d&&!e._skipRoute&&Ember.run.once(function(){e._skipPush=!0,c(e,"location",d),e._skipPush=!1}),e._skipRoute=!1},popState:function(a){var d=this,e=b(d,"baseURI"),f=e.charAt(0)==="/"?document.location.pathname:document.location.href;f.slice(0,e.length)===e&&(f=f.slice(e.length+1,f.length),b(d,"location")!==f&&!d._skipRoute&&Ember.run.once(function(){d._skipPush=!0,c(d,"location",f),d._skipPush=!1})),d._skipRoute=!1},__nullState:Ember.State.create({enabled:!1})})})({}),function(a){}({})
